# 要件定義書

## 概要

registry-firewallは、ソフトウェアサプライチェーン攻撃から開発環境を保護するための統合レジストリプロキシです。OSVやOpenSSF Malicious Packagesなどの外部セキュリティデータソースと連携し、悪意あるパッケージやバージョンをフィルタリングします。プラグインアーキテクチャにより、対応言語やセキュリティソースを柔軟に拡張できます。

### 背景

2025年9月のShai-Hulud npm供給チェーン攻撃（500以上のパッケージが侵害）に代表されるように、パッケージレジストリを経由した攻撃が増加しています。本システムは、Home Lab環境でも導入可能な軽量かつ拡張性の高いソリューションを提供します。

### 目標

- 悪意あるパッケージの自動ブロック
- 複数言語エコシステムの統一的な保護
- 低運用コストでの継続的なセキュリティ確保
- OpenTelemetryによる標準的な可観測性の提供
- Web UIによる直感的な管理インターフェース

---

## ユーザーストーリー

### ストーリー1: 安全なパッケージ取得

**私は** 開発者として
**〜したい** 通常のパッケージマネージャーコマンド（pip, go get, cargo, npm等）を使いながら、悪意あるパッケージから保護されたい
**なぜなら** 開発ワークフローを変更せずにセキュリティを向上させたいから

#### 受入基準（EARS記法）

- REQ-001: 開発者がパッケージをリクエストした時、システムはセキュリティDBと照合してブロック判定を行わなければならない
- REQ-002: パッケージがブロック対象の場合、システムは403 Forbiddenとブロック理由をJSON形式で返却しなければならない
- REQ-003: パッケージがブロック対象でない場合、システムはアップストリームレジストリからパッケージを取得して返却しなければならない
- REQ-004: メタデータリクエストの場合、システムはブロック対象バージョンを除外したメタデータを返却しなければならない

---

### ストーリー2: セキュリティデータの自動更新

**私は** システム管理者として
**〜したい** セキュリティ情報が自動的に更新されてほしい
**なぜなら** 手動でブロックリストをメンテナンスしたくないから

#### 受入基準（EARS記法）

- REQ-005: システム起動時、システムは有効化されたすべてのセキュリティソースプラグインから初期データを同期しなければならない
- REQ-006: 設定された同期間隔ごとに、システムは各セキュリティソースプラグインのデータを更新しなければならない
- REQ-007: 同期に失敗した場合、システムは既存のキャッシュデータを使用し続け、エラーをログに記録しなければならない
- REQ-008: 同期完了時、システムはメトリクスを更新しなければならない

---

### ストーリー3: パッケージキャッシュによる高速化

**私は** 開発者として
**〜したい** 頻繁に使用するパッケージを高速に取得したい
**なぜなら** ビルド時間を短縮し、外部レジストリへの依存を減らしたいから

#### 受入基準（EARS記法）

- REQ-009: パッケージが初回リクエストされた時、システムはアップストリームから取得後、ローカルキャッシュに保存しなければならない
- REQ-010: キャッシュ済みパッケージがリクエストされた時、システムはキャッシュから直接返却しなければならない
- REQ-011: キャッシュのTTLが期限切れの場合、システムはアップストリームから再取得してキャッシュを更新しなければならない
- REQ-012: キャッシュストレージが上限に達した場合、システムはLRUポリシーで古いエントリを削除しなければならない

---

### ストーリー4: プラグインによる拡張

**私は** システム管理者として
**〜したい** 新しい言語やセキュリティソースを追加できるようにしたい
**なぜなら** 将来の要件変更に柔軟に対応したいから

#### 受入基準（EARS記法）

- REQ-013: 設定ファイルでレジストリプラグインが有効化されている場合、システムは該当プラグインをロードしてルーティングを設定しなければならない
- REQ-014: 設定ファイルでセキュリティソースプラグインが有効化されている場合、システムは該当プラグインをロードして同期を開始しなければならない
- REQ-015: 無効なプラグイン設定が検出された場合、システムは起動時にエラーメッセージを出力して終了しなければならない
- REQ-016: プラグインが定義されたインターフェースを実装している場合、システムは新規プラグインを追加のコード変更なしで認識できなければならない

---

### ストーリー5: OpenTelemetryによる可観測性

**私は** システム管理者として
**〜したい** 標準的な可観測性スタックでシステムを監視したい
**なぜなら** 既存の監視基盤（Grafana, Jaeger等）と統合し、問題の根本原因を特定したいから

#### 受入基準（EARS記法）

- REQ-017: システム起動時、OTELが有効化されている場合、システムはOTEL Collectorへの接続を確立しなければならない
- REQ-018: HTTPリクエストを受信した時、システムはトレーススパンを生成し、リクエスト処理全体を追跡しなければならない
- REQ-019: アップストリームへのリクエスト時、システムは子スパンを生成してアップストリームレイテンシを計測しなければならない
- REQ-020: セキュリティDBチェック時、システムは子スパンを生成してチェック処理時間を計測しなければならない
- REQ-021: システムはOTEL Metrics APIを使用してカウンター、ヒストグラム、ゲージを公開しなければならない
- REQ-022: システムはOTEL Logs APIを使用して構造化ログをエクスポートしなければならない
- REQ-023: OTEL Collectorが利用不可の場合、システムはローカルにフォールバックして動作を継続しなければならない

---

### ストーリー6: 管理用Web UI

**私は** システム管理者として
**〜したい** Webブラウザからシステムの状態確認と設定変更を行いたい
**なぜなら** CLIやファイル編集なしで直感的に管理したいから

#### 受入基準（EARS記法）

- REQ-024: `/ui`にアクセスした時、システムは管理用Web UIを表示しなければならない
- REQ-025: ダッシュボード画面において、システムはリクエスト数、ブロック数、キャッシュヒット率をリアルタイム表示しなければならない
- REQ-026: ブロックログ画面において、システムは直近のブロックイベントを一覧表示しなければならない
- REQ-027: セキュリティDB画面において、システムは各セキュリティソースの同期状態と最終更新日時を表示しなければならない
- REQ-028: キャッシュ管理画面において、システムはキャッシュ使用量と上位パッケージを表示しなければならない
- REQ-029: カスタムブロックリスト画面において、システムはブロックルールの追加・編集・削除を可能にしなければならない
- REQ-030: 手動同期ボタンがクリックされた時、システムは即座にセキュリティDBの同期を実行しなければならない
- REQ-031: キャッシュクリアボタンがクリックされた時、システムは確認後にキャッシュを削除しなければならない

---

### ストーリー7: クライアント認証

**私は** システム管理者として
**〜したい** 許可されたクライアントのみがプロキシを使用できるようにしたい
**なぜなら** 不正なアクセスを防ぎ、利用状況をクライアント単位で追跡したいから

#### 受入基準（EARS記法）

- REQ-032: 認証が有効化されている場合、システムはすべてのプロキシリクエストで認証トークンを検証しなければならない
- REQ-033: 有効なトークンが提供されていない場合、システムは401 Unauthorizedを返却しなければならない
- REQ-034: 管理者がWeb UIでAPIトークンを生成した時、システムは一意のトークンを作成してDBに保存しなければならない
- REQ-035: トークン生成時、システムはトークン名、有効期限、許可エコシステムを設定可能にしなければならない
- REQ-036: トークンの有効期限が切れている場合、システムは401 Unauthorizedを返却しなければならない
- REQ-037: トークンに許可エコシステムが設定されている場合、システムは許可されていないエコシステムへのアクセスを403 Forbiddenで拒否しなければならない
- REQ-038: 認証されたリクエストにおいて、システムはクライアント識別子をログとメトリクスに含めなければならない
- REQ-039: `/health`と`/metrics`エンドポイントにおいて、システムは認証をスキップしなければならない
- REQ-040: Basic認証ヘッダーが提供された場合、システムはユーザー名をクライアント名、パスワードをトークンとして処理しなければならない

---

### ストーリー8: カスタムブロックリスト

**私は** システム管理者として
**〜したい** 組織固有のブロックルールを追加したい
**なぜなら** 外部DBにない内部ポリシーやゼロデイ対応を行いたいから

#### 受入基準（EARS記法）

- REQ-041: カスタムブロックリストファイルが設定されている場合、システムは起動時にファイルを読み込みブロックルールに追加しなければならない
- REQ-042: カスタムブロックリストでバージョン範囲が指定されている場合、システムはセマンティックバージョン範囲でマッチングしなければならない
- REQ-043: カスタムブロックリストでワイルドカードパターンが指定されている場合、システムはパッケージ名をパターンマッチングしなければならない
- REQ-044: カスタムブロックリストがWeb UIで更新された場合、システムは即座にルールを反映しなければならない
- REQ-045: カスタムブロックリストファイルが変更された場合、システムは設定された間隔でリロードしなければならない

---

## 非機能要件

### 性能

- NFR-001: システムはキャッシュヒット時に50ms以内でレスポンスを返却できなければならない
- NFR-002: システムはキャッシュミス時でもアップストリームレイテンシ+100ms以内でレスポンスを返却できなければならない
- NFR-003: システムは100件/秒の同時リクエストを処理できなければならない
- NFR-004: セキュリティDBチェックは1ms以内で完了しなければならない
- NFR-005: 認証トークン検証は0.5ms以内で完了しなければならない
- NFR-006: Web UIは初期ロード3秒以内で表示されなければならない

### 可用性

- NFR-007: アップストリームレジストリが利用不可の間、システムはキャッシュ済みパッケージを返却し続けなければならない
- NFR-008: セキュリティDBの同期に失敗しても、システムは既存データで動作を継続しなければならない
- NFR-009: OTEL Collectorが利用不可でも、システムは正常に動作を継続しなければならない

### リソース

- NFR-010: システムはアイドル時に256MB以下のメモリで動作しなければならない
- NFR-011: システムはRaspberry Pi 4（4GB RAM）で動作可能でなければならない
- NFR-012: Web UIはモダンブラウザ（Chrome, Firefox, Safari, Edge最新版）で動作しなければならない

### セキュリティ

- NFR-013: システムはアップストリームへの接続にTLS 1.2以上を使用しなければならない
- NFR-014: ブロックリストDBファイルは読み取り専用でマウント可能でなければならない
- NFR-015: APIトークンはbcryptまたはargon2でハッシュ化して保存しなければならない
- NFR-016: Web UIへのアクセスは認証を必須としなければならない
- NFR-017: 認証失敗が10回連続した場合、システムは該当IPを5分間ブロックしなければならない

### 可観測性

- NFR-018: システムはOpenTelemetry Protocol（OTLP）でトレース、メトリクス、ログをエクスポートできなければならない
- NFR-019: すべてのログはJSON形式で構造化されていなければならない
- NFR-020: トレースにはリクエストID、クライアントID、エコシステム、パッケージ名が含まれなければならない

### 保守性

- NFR-021: システムは単一のDockerイメージとしてデプロイ可能でなければならない
- NFR-022: すべての設定は環境変数またはYAMLファイルで指定可能でなければならない
- NFR-023: プラグイン追加時に既存コードの修正が不要でなければならない
- NFR-024: Web UIは単一バイナリに組み込まれ、追加のWebサーバーが不要でなければならない

---

## 用語集

| 用語 | 定義 |
|------|------|
| OSV | Open Source Vulnerabilities - Googleが管理するオープンソース脆弱性データベース |
| OpenSSF | Open Source Security Foundation - オープンソースセキュリティ財団 |
| EARS | Easy Approach to Requirements Syntax - 要件記述のための標準記法 |
| アップストリーム | 公式パッケージレジストリ（pypi.org, proxy.golang.org等） |
| エコシステム | パッケージ管理システムの種別（pypi, go, cargo, npm, docker等） |
| npm | Node Package Manager - JavaScriptのパッケージマネージャー |
| スコープ付きパッケージ | npmの@scope/package形式のパッケージ名（例: @types/node） |
| レジストリプラグイン | 特定のパッケージレジストリプロトコルを実装するプラグイン |
| セキュリティソースプラグイン | セキュリティ情報の取得元を実装するプラグイン |
| OTEL | OpenTelemetry - 可観測性のためのオープンスタンダード |
| OTLP | OpenTelemetry Protocol - OTELのデータ転送プロトコル |
| スパン | トレースにおける処理の単位 |
| APIトークン | クライアント認証に使用する秘密鍵 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2025-12-02 | 初版作成 | - |
| 1.1 | 2025-12-02 | OTEL、管理用WebUI、クライアント認証を追加 | - |
| 1.2 | 2025-12-10 | npmレジストリプラグインのサポートを追加 | - |